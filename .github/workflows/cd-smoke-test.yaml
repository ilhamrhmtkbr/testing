name: cd-smoke-test.yaml

on:
  workflow_call:

jobs:
  smoke-test:
    runs-on: ubuntu-latest@v4

    steps:
      - uses: actions/checkout@v4

      - name: Generate Environment Variables
        id: secrets
        run: |
          JWT_SECRET=$(openssl rand -base64 64)
          APP_KEY="base64:$(openssl rand -base64 32)"

          echo "jwt_secret=$JWT_SECRET" >> $GITHUB_OUTPUT
          echo "app_key=$APP_KEY" >> $GITHUB_OUTPUT
          echo "::add-mask::$JWT_SECRET"
          echo "::add-mask::$APP_KEY"

      - name: Create Minimal Environment Files
        env:
          APP_KEY: ${{ steps.secrets.outputs.app_key }}
          JWT_SECRET: ${{ steps.secrets.outputs.jwt_secret }}
        run: |
          cd docker/prod

          cat > .env.secret-shared << EOF
          APP_KEY=$APP_KEY
          DB_HOST=database-mysql
          DB_DATABASE=iamra_course
          DB_USERNAME=root
          DB_PASSWORD=root
          JWT_SECRET=$JWT_SECRET
          REDIS_HOST=database-redis
          REDIS_PASSWORD=null
          REDIS_PORT=6379
          EOF

          cat > .env.secret-user << EOF
          APP_URL=http://backend-api-user
          AUTH_GUARD=api
          EOF

          cat > .env.secret-public << EOF
          APP_URL=http://backend-api-public
          EOF

      - name: Start Minimal Services
        run: |
          cd docker/prod

          echo "ğŸš€ Starting essential services only..."
          docker compose -f docker-compose-cd-integration-test.yaml up -d \
            database-mysql database-redis backend-api-user backend-api-public

          echo "â³ Waiting for services..."
          timeout 120 bash -c 'until docker compose -f docker-compose-cd-integration-test.yaml ps database-mysql | grep -q "healthy"; do sleep 2; done'
          sleep 15

      - name: Health Checks
        run: |
          cd docker/prod

          echo "ğŸ” Running health checks..."

          # Test Redis connection
          docker compose -f docker-compose-cd-integration-test.yaml exec -T \
            backend-api-user php artisan tinker --execute="Redis::ping(); echo 'Redis OK';" || exit 1

          echo "âœ… Smoke test passed!"

      - name: Cleanup
        if: always()
        run: |
          cd docker/prod
          docker compose -f docker-compose-cd-integration-test.yaml down -v