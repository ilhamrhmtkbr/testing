name: Integration Testing

on:
  workflow_call:

jobs:
  integration-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Step 1: Generate shared secrets untuk semua container
      - name: Generate Shared Environment Variables
        id: secrets
        run: |
          JWT_SECRET=$(openssl rand -base64 64)
          APP_KEY="base64:$(openssl rand -base64 32)"
          BUILD_TAG="build-$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA:0:7}"

          echo "jwt_secret=$JWT_SECRET" >> $GITHUB_OUTPUT
          echo "app_key=$APP_KEY" >> $GITHUB_OUTPUT
          echo "build_tag=$BUILD_TAG" >> $GITHUB_OUTPUT

          echo "::add-mask::$JWT_SECRET"
          echo "::add-mask::$APP_KEY"

      # Step 2: Create environment files dengan generated secrets
      - name: Create Environment Files
        env:
          APP_KEY: ${{ steps.secrets.outputs.app_key }}
          JWT_SECRET: ${{ steps.secrets.outputs.jwt_secret }}
          USER_REVERB_APP_ID: ${{ secrets.USER_REVERB_APP_ID }}
          USER_REVERB_APP_KEY: ${{ secrets.USER_REVERB_APP_KEY }}
          USER_REVERB_APP_SECRET: ${{ secrets.USER_REVERB_APP_SECRET }}
          FORUM_REVERB_APP_ID: ${{ secrets.FORUM_REVERB_APP_ID }}
          FORUM_REVERB_APP_KEY: ${{ secrets.FORUM_REVERB_APP_KEY }}
          FORUM_REVERB_APP_SECRET: ${{ secrets.FORUM_REVERB_APP_SECRET }}
          RECAPTCHA_SECRET_KEY: ${{ secrets.RECAPTCHA_SECRET_KEY }}
        run: |
          cd docker/prod
          
          cat > .env.secret-shared << EOF
          APP_KEY=$APP_KEY
          DB_HOST=database-mysql
          DB_PASSWORD=root
          JWT_SECRET=$JWT_SECRET
          REDIS_HOST=database-redis
          REDIS_PASSWORD=null
          REDIS_PORT=6379
          EOF
          
          cat > .env.secret-user << EOF
          APP_URL=https://api-user.course.iamra.site
          AUTH_GUARD=api
          JWT_COOKIE_DOMAIN_PROD=.iamra.site
          BROADCAST_CONNECTION=reverb
          REVERB_APP_ID=$USER_REVERB_APP_ID
          REVERB_APP_KEY=$USER_REVERB_APP_KEY
          REVERB_APP_SECRET=$USER_REVERB_APP_SECRET
          REVERB_HOST=backend-api-user-reverb
          REVERB_PORT=8080
          REVERB_SCHEME=http
          RECAPTCHA_SECRET_KEY=$RECAPTCHA_SECRET_KEY
          EOF
          
          cat > .env.secret-student << EOF
          APP_URL=https://api-student.course.iamra.site
          EOF
          
          cat > .env.secret-instructor << EOF
          APP_URL=https://api-instructor.course.iamra.site
          EOF
          
          cat > .env.secret-public << EOF
          APP_URL=https://api-public.course.iamra.site
          EOF

          cat > .env.secret-forum << EOF
          APP_URL=https://api-forum.course.iamra.site
          BROADCAST_CONNECTION=reverb
          REVERB_APP_ID=$FORUM_REVERB_APP_ID
          REVERB_APP_KEY=$FORUM_REVERB_APP_KEY
          REVERB_APP_SECRET=$FORUM_REVERB_APP_SECRET
          REVERB_HOST=backend-api-forum-reverb
          REVERB_PORT=8080
          REVERB_SCHEME=http
          EOF

      # Step 3: Start Docker dengan environment files yang udah dibuat
      - name: Start Docker Services
        run: |
          cd docker/prod

          echo "ğŸš€ Starting Docker services..."

          # Start databases dulu
          sudo docker compose -f docker-compose-cd-integration-test.yaml up -d database-mysql database-redis database-mongo
          echo "â³ Waiting for databases..."
          sleep 45

          # Start user API dulu (most important)
          sudo docker compose -f docker-compose-cd-integration-test.yaml up -d backend-api-user
          echo "â³ Waiting for user API..."
          sleep 30

          # Start services yang depend ke user API
          sudo docker compose -f docker-compose-cd-integration-test.yaml up -d backend-api-student backend-api-instructor backend-api-forum backend-api-public
          echo "â³ Waiting for all APIs..."
          sleep 45

          # Check if all containers are running
          sudo docker compose -f docker-compose-cd-integration-test.yaml ps

      # Step 4: Verify and Clear Cache
      - name: Verify and Clear Cache
        run: |
          cd docker/prod
          echo "ğŸ” Verifying environment files..."
          
          for service in user student instructor forum public; do
            echo "Checking backend-api-$service..."
            sudo docker compose -f docker-compose-cd-integration-test.yaml exec -T backend-api-$service cat .env
          
            echo "Clearing cache for backend-api-$service..."
            sudo docker compose -f docker-compose-cd-integration-test.yaml exec -T backend-api-$service php artisan config:clear
            sudo docker compose -f docker-compose-cd-integration-test.yaml exec -T backend-api-$service php artisan cache:clear
          done

      # Step 5: Install Composer
      - name: Install Composer Dependencies
        run: |
          cd docker/prod
          for containerName in user student instructor forum public; do
             sudo docker compose -f docker-compose-cd-integration-test.yaml exec -T backend-api-${containerName} composer install --optimize-autoloader --no-interaction
          done

      # Step 6: Setup Laravel applications
      - name: Migration and Seeder
        run: |
          cd docker/prod
          sudo docker compose -f docker-compose-cd-integration-test.yaml exec -T backend-api-public php artisan migrate:fresh --seed

      # Step 7: Testing
      - name: Integration Testing
        run: |
          cd docker/prod
          echo "Testing..."
          
          for containerName in user student instructor forum public; do
            sudo docker compose -f docker-compose-cd-integration-test.yaml exec -T backend-api-${containerName} php artisan test --stop-on-failure
          done

      # Step 8: Cleanup
      - name: Cleanup Docker
        if: always()
        run: |
          cd docker/prod
          sudo docker compose -f docker-compose-cd-integration-test.yaml down -v --remove-orphans
          sudo docker system prune -f