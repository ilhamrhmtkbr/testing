services:
  nginx:
    image: nginxinc/nginx-unprivileged:alpine
    container_name: nginx
    user: "1000:1000"
    ports:
      - "80:8080"
      - "443:8443"
    volumes:
      - "./../../frontend-forum/dist:/var/www/html/forum"
      - "./../../frontend-public/dist:/var/www/html/public"
      - "./../../frontend-student/dist:/var/www/html/student"
      - "./../../frontend-instructor/dist:/var/www/html/instructor"
      - "./../../frontend-user/dist:/var/www/html/user"
      - "./server-entrypoint/nginx.conf:/etc/nginx/nginx.conf:ro"
      - shared-sockets:/var/run/sockets:rw
      - nginx-cache:/var/cache/nginx
    networks:
      - app-network
    restart: unless-stopped
    mem_limit: 40M
    cpus: 0.05

  database-mysql:
    image: mysql:latest
    container_name: database-mysql
    restart: always
    volumes:
      - mysql_data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: iamra_course
    ports:
      - "3307:3306"
    networks:
      - app-network
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      retries: 5
      timeout: 5s

  backend-api-user:
    build:
      context: ../../
      dockerfile: docker/prod/backend-laravel/user/Dockerfile.api-user
    container_name: backend-api-user
    env_file:
      - .env.secret-user
    volumes:
      - shared-sockets:/var/run/sockets:rw
      - "../../backend-api-user:/app"
      - ".env.shared:/app/.env"
    command: ["./rr", "serve", "-c", ".rr.yaml"]
    networks:
      - app-network
    restart: unless-stopped
    mem_limit: 120M
    cpus: '0.15'

  backend-api-user-reverb:
    build:
      context: ../../
      dockerfile: docker/prod/backend-laravel/user/Dockerfile.api-user-reverb
    container_name: backend-api-user-reverb
    env_file:
      - .env.secret-user
    volumes:
      - ".env.shared:/app/.env"
    networks:
      - app-network
    restart: unless-stopped
    expose:
      - "8080"
    mem_limit: 80M
    cpus: '0.1'

  backend-api-public:
    build:
      context: ../../
      dockerfile: docker/prod/backend-laravel/public/Dockerfile.api-public
    container_name: backend-api-public
    env_file:
      - .env.secret-public
    volumes:
      - shared-sockets:/var/run/sockets:rw
      - "../../backend-api-public:/app"
      - ".env.shared:/app/.env"
    command: ["./rr", "serve", "-c", ".rr.yaml"]
    networks:
      - app-network
    restart: unless-stopped
    mem_limit: 120M
    cpus: '0.1'

  backend-api-student:
    build:
      context: ../../
      dockerfile: docker/prod/backend-laravel/student/Dockerfile.api-student
    container_name: backend-api-student
    env_file:
      - .env.secret-student
    volumes:
      - shared-sockets:/var/run/sockets:rw
      - "../../backend-api-student:/app"
      - ".env.shared:/app/.env"
    command: ["./rr", "serve", "-c", ".rr.yaml"]
    networks:
      - app-network
    restart: unless-stopped
    mem_limit: 120M
    cpus: '0.1'

  backend-api-instructor:
    build:
      context: ../../
      dockerfile: docker/prod/backend-laravel/instructor/Dockerfile.api-instructor
    container_name: backend-api-instructor
    env_file:
      - .env.secret-instructor
    volumes:
      - shared-sockets:/var/run/sockets:rw
      - "../../backend-api-instructor:/app"
      - ".env.shared:/app/.env"
    command: ["./rr", "serve", "-c", ".rr.yaml"]
    networks:
      - app-network
    restart: unless-stopped
    mem_limit: 120M
    cpus: '0.1'

  backend-api-forum:
    build:
      context: ../../
      dockerfile: docker/prod/backend-laravel/forum/Dockerfile.api-forum
    container_name: backend-api-forum
    env_file:
      - .env.secret-forum
    volumes:
      - shared-sockets:/var/run/sockets:rw
      - "../../backend-api-forum:/app"
      - ".env.shared:/app/.env"
    command: ["./rr", "serve", "-c", ".rr.yaml"]
    networks:
      - app-network
    restart: unless-stopped
    mem_limit: 120M
    cpus: '0.1'

  backend-api-forum-reverb:
    build:
      context: ../../
      dockerfile: docker/prod/backend-laravel/forum/Dockerfile.api-forum-reverb
    container_name: backend-api-forum-reverb
    env_file:
      - .env.secret-forum
    volumes:
      - ".env.shared:/app/.env"
    networks:
      - app-network
    restart: unless-stopped
    expose:
      - "8080"
    mem_limit: 80M
    cpus: '0.1'

networks:
  app-network:
    driver: bridge

volumes:
  mysql_data:
  shared-sockets:
  nginx-cache:
  nginx-run: